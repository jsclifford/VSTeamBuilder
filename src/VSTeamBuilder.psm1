<#          License
    GNU GENERAL PUBLIC LICENSE
     Version 3, 29 June 2007
        See License.txt
#>

function New-TBOrg
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            New-TBOrg will do something wonderful.
        .DESCRIPTION
            New-TBOrg will do something wonderful.
        .EXAMPLE
            New-TBOrg -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Remove-TBOrg
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Remove-TBOrg will do something wonderful.
        .DESCRIPTION
            Remove-TBOrg will do something wonderful.
        .EXAMPLE
            Remove-TBOrg -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function New-TBTeam
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            New-TBTeam will do something wonderful.
        .DESCRIPTION
            New-TBTeam will do something wonderful.
        .EXAMPLE
            New-TBTeam -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Remove-TBTeam
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Remove-TBTeam will do something wonderful.
        .DESCRIPTION
            Remove-TBTeam will do something wonderful.
        .EXAMPLE
            Remove-TBTeam -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function New-TBSecurityGroup
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            New-TBSecurityGroup will do something wonderful.
        .DESCRIPTION
            New-TBSecurityGroup will do something wonderful.
        .EXAMPLE
            New-TBSecurityGroup -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Get-TBSecurityGroup
{
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
    <#
        .SYNOPSIS
            Get-TBSecurityGroup will do something wonderful.
        .DESCRIPTION
            Get-TBSecurityGroup will do something wonderful.
        .EXAMPLE
            Get-TBSecurityGroup -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Add-TBSecurityGroupMember
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Add-TBSecurityGroupMember will do something wonderful.
        .DESCRIPTION
            Add-TBSecurityGroupMember will do something wonderful.
        .EXAMPLE
            Add-TBSecurityGroupMember -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Remove-TBSecurityGroupMember
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Remove-TBSecurityGroupMember will do something wonderful.
        .DESCRIPTION
            Remove-TBSecurityGroupMember will do something wonderful.
        .EXAMPLE
            Remove-TBSecurityGroupMember -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Set-TBTeamAreaSetting
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Set-TBTeamAreaSetting will do something wonderful.
        .DESCRIPTION
            Set-TBTeamAreaSetting will do something wonderful.
        .EXAMPLE
            Set-TBTeamAreaSetting -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Get-TBTeamAreaSetting
{
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
    <#
        .SYNOPSIS
            Get-TBTeamAreaSetting will do something wonderful.
        .DESCRIPTION
            Get-TBTeamAreaSetting will do something wonderful.
        .EXAMPLE
            Get-TBTeamAreaSetting -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Set-TBTeamIterationSetting
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Set-TBTeamIterationSetting will do something wonderful.
        .DESCRIPTION
            Set-TBTeamIterationSetting will do something wonderful.
        .EXAMPLE
            Set-TBTeamIterationSetting -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Get-TBTeamIterationSetting
{
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
    <#
        .SYNOPSIS
            Get-TBTeamIterationSetting will do something wonderful.
        .DESCRIPTION
            Get-TBTeamIterationSetting will do something wonderful.
        .EXAMPLE
            Get-TBTeamIterationSetting -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Add-TBTeamIteration
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Add-TBTeamIteration will do something wonderful.
        .DESCRIPTION
            Add-TBTeamIteration will do something wonderful.
        .EXAMPLE
            Add-TBTeamIteration -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Get-TBTeamIteration
{
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
    <#
        .SYNOPSIS
            Get-TBTeamIteration will do something wonderful.
        .DESCRIPTION
            Get-TBTeamIteration will do something wonderful.
        .EXAMPLE
            Get-TBTeamIteration -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Set-TBPermission
{
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
     if($PSCmdlet.ShouldProcess("Processing section 1.")){
        #Process something here.
    }
    <#
        .SYNOPSIS
            Set-TBPermission will do something wonderful.
        .DESCRIPTION
            Set-TBPermission will do something wonderful.
        .EXAMPLE
            Set-TBPermission -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Get-TBTokenCollection
{
    Param(

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName1,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName2,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName3,

        # Parameter help description
        [Parameter(Mandatory = $true)]
        [string]
        $ParameterName4
    )
    <#
        .SYNOPSIS
            Get-TBTokenCollection will do something wonderful.
        .DESCRIPTION
            Get-TBTokenCollection will do something wonderful.
        .EXAMPLE
            Get-TBTokenCollection -Paramater1 "test" -Paramater2 "test2" -Paramater3 "test3" -Paramater4 "test4"
    #>
}
function Get-TBNamespaceCollection
{
    [cmdletbinding()]
    Param(

        # Refresh the Collection object in memory
        [switch]
        $ForceRefresh
    )

    #region global connection Variables
    $projectNameLocal = $null
    $VSTBConn = $Global:VSTBConn
    if(! (_testConnection)){
        Write-Verbose "There is no connection made to the server.  Run Add-TBConnection to connect."
        return
    }
    if($null -eq $ProjectName){
        if($null -eq $VSTBConn.DefaultProjectName){
            Write-Verbose "No ProjectName specified."
            throw "No Default ProjectName or ProjectName Variable specified.  Set the default project or pass the project name."
        }else{
            $projectNameLocal = $VSTBConn.DefaultProjectName
        }
    }else{
        $projectNameLocal = $ProjectName
    }
    #endregion

    if($null -eq $Global:TFSnamespaceCollection -or $ForceRefresh){
        $namespaces = Invoke-VSTeamRequest -area "securitynamespaces" -resource "00000000-0000-0000-000000000000" -method -Get -version 1.0
        $Global:TFSnamespaceCollection = $namespaces.value
        return $namespaces.value
    }else{
        return $Global:TFSnamespaceCollection
    }
    <#
        .SYNOPSIS
            Get-TBNamespaceCollection pulls all namespaces from TFS for permission identification.
        .DESCRIPTION
            Get-TBNamespaceCollection pulls all namespaces from TFS for permission identification.  This is primarily used in Set-TBPermission.  This functions
            sets the variable $Global:VSTBNamespaceCollection.
        .EXAMPLE
            Get-TBNamespaceCollection
        .EXAMPLE
            Get-TBNamespaceCollection -ForceRefresh
            This refreshes the Global variable $Global:VSTBNamespaceCollection
    #>
}
function Get-TBToken
{
    [cmdletbinding()]
    Param(

        # TFS ObjectID (Group Name)
        [Parameter(Mandatory = $true)]
        [string]
        $ObjectId,

        # NamespaceName
        [Parameter(Mandatory = $true)]
        [string]
        $NsName,

        # Team Project to search from
        [Parameter(Mandatory = $false)]
        [string]
        $ProjectName
    )
    #region global connection Variables
    $projectNameLocal = $null
    $tokenCollection = $null
    $VSTBConn = $Global:VSTBConn
    if(! (_testConnection)){
        Write-Verbose "There is no connection made to the server.  Run Add-TBConnection to connect."
        return
    }
    if($null -eq $ProjectName){
        if($null -eq $VSTBConn.DefaultProjectName){
            Write-Verbose "No ProjectName specified."
            throw "No Default ProjectName or ProjectName Variable specified.  Set the default project or pass the project name."
        }else{
            $projectNameLocal = $VSTBConn.DefaultProjectName
        }
    }else{
        $projectNameLocal = $ProjectName
    }
    #endregion

    #region Get Namespaceid from name
    if($null -eq $Global:VSTBNamespaceCollection){
        $holder = Get-TBNamespaceCollection
    }

    $nameSpaceId = ($Global:VSTBNamespaceCollection | Where-Object -Property name -eq $NsName).Namespaceid

    if($null -eq $nameSpaceId){
        Write-Verbose "Could not find namespace id. Exiting."
        return
    }else{
        Write-Verbose "Found Namespace Id: $nameSpaceId"
    }
    #endregion

    #region Get VSTB Token Collection
    $tokenCollection = $null
    if($null -eq $Global:VSTBTokencollection){
        $tokenCollection = Get-TBTokenCollection -NamespaceId $nameSpaceId -Project $projectNameLocal
    }else{
        if($Global:VSTBTokencollection.ContainsKey($nameSpaceId)){
            $tokenCollection = $Global:VSTBTokencollection[$nameSpaceId]
        }else{
            $tokenCollection = Get-TBTokenCollection -NamespaceId $nameSpaceId -Project $projectNameLocal
        }
    }
    #endregion

    $token = $tokenCollection | Where-Object -Property Token -match "^.*$ObjectId$"

    if($null -eq $token){
        $updateTokencollection = Get-TBTokenCollection -NamespaceId $nameSpaceId -Project $projectNameLocal -ForceRefresh
        $token = $updateTokencollection | Where-Object -Property Token -match "^.*$ObjectId$"
    }

    $props = @{
        "namespaceId" = $nameSpaceId
        "token" = $token.token
    }
    $returnObj = New-Object -TypeName PSObject -Property $props

    return $returnObj

    <#
        .SYNOPSIS
            Get-TBToken return a token object with namespaceid and token id
        .DESCRIPTION
            Get-TBToken return a token object with namespaceid and token id
        .EXAMPLE
            Get-TBToken -ObjectId "group1" -NsName "security" -ProjectName "myproject"
    #>
}
function Add-TBConnection
{
    [OutputType([boolean])]
    [cmdletbinding(SupportsShouldProcess = $true, ConfirmImpact = "Medium")]
    Param(

        # TFS/VSTS Collection Name
        [Parameter(Mandatory = $true)]
        [string]
        $CollectionName,

        # TFS/VSTS Server URL or domain
        [Parameter(Mandatory = $true)]
        [string]
        $ServerURL,

        # PAT Token
        [Parameter(Mandatory = $false)]
        [string]
        $PAT
    )

    $Success = $true
    $CollectionUrl = "$ServerUrl/$CollectionName"
    $VSTBConn = $Global:VSTBConn

    if($null -eq $VSTBConn){
        # if($ServerURL -eq $null -or $ServerURL -eq ''){
        #     $ErrorState = $true
        #     throw "No ServerURL parameter available."
        # }
        $props = @{
            "ServerURL" = $ServerURL
            "CollectionName" = $CollectionName
            "TeamExplorerConnection" = $null
            "DefaultProjectName" = $null
            "VSTeamAccount" = $false
        }

        $VSTBConn = New-Object -TypeName psobject -Property $props
    }
    if($null -eq $($VSTBConn.TeamExplorerConnection)){
        try{
            #$TFSCmdletsModuleBase = (Get-Module -ListAvailable TfsCmdlets).ModuleBase

            $tfs = [Microsoft.TeamFoundation.Client.TfsTeamProjectCollectionFactory]::GetTeamProjectcollection($CollectionUrl)
            $VSTBconn.TeamExplorerConnection = $tfs
            Write-Verbose "Successfully conected TFS client DLL to: $CollectionName"
        }catch{
            Write-Verbose "There was an error $_"
            $Success = $false
        }
    }else{
        Write-Verbose "Already Connected to TFOM."
    }

    if($null -eq $env:TEAM_ACCT){
        Add-VSTeamAccount -Account $CollectionUrl -UseWindowsAuthentication
        $VSTBConn.VSTeamAccount = $true
        Write-Verbose "Successfully connected TFS VSTeam to: $CollectionName"
    }else{
        Write-Verbose "Already Connected to VSTeam"
    }

    $Global:VSTBConn = $VSTBConn

    return $Success

    <#
        .SYNOPSIS
            Add-TBConnection will add TB Connection to current session.
        .DESCRIPTION
            Add-TBConnection will add TB Connection to current session.
        .EXAMPLE
            Add-TBConnection -CollectionName "test" -ServerUrl "http://mywebsite.com/tfs"
    #>
}

function Remove-TBConnection
{
    [OutputType([boolean])]
    Param(
        # All Variables switch does nothing.
        [switch]
        $AllVariables
    )

    $Success = $true
    $CollectionUrl = "$ServerUrl/$CollectionName"
    $VSTBConn = $Global:VSTBConn

    if($VSTBConn -ne $null){
        try{
            $Global:VSTBConn = $null
        }catch{
            Write-Verbose "There was an error $_"
            $Success = $false
        }
    }
    if($null -ne $env:TEAM_ACCT){
        Remove-VSTeamAccount
    }
    $Global:VSTBNamespaceCollection = $null
    $Global:VSTBTokencollection = $null


    return $Success
    <#
        .SYNOPSIS
            Remove-TBConnection will remove Global Variable for this module.
        .DESCRIPTION
            Remove-TBConnection will remove Global Variable for this module.
        .EXAMPLE
            Remove-TBConnection
    #>
}

function _testConnection
{
    [OutputType([boolean])]
    Param(
        # Test all variables
        [switch]
        $TestAll
    )

    $VSTBConn = $Global:VSTBConn
    if($null -eq $VSTBConn.ServerURL -and $null -eq $VSTBConn.CollectionName -and $null -eq $VSTBConn.TeamExplorerConnection){
        return $false
    }else{
        return $true
    }
    <#
        .SYNOPSIS
            _testTBConnection tests if TFS connection is made.
        .DESCRIPTION
            _testTBConnection tests if TFS connection is made.
        .EXAMPLE
            _testTBConnection
    #>
}

function Set-TBDefaultProject
{
    Param(

        # TFS/VSTS Project
        [Parameter(Mandatory = $true)]
        [string]
        $ProjectName
    )

    $VSTBVersionTable.DefaultProject = $ProjectName
    <#
        .SYNOPSIS
            Set-TBDefaultProject will add the project name to the $VSTBVersionTable Object.
        .DESCRIPTION
            Set-TBDefaultProject will add the project name to the $VSTBVersionTable Object and have all other
            functions use it.
        .EXAMPLE
            Set-TBDefaultProject -ProjectName "MyProjectName"
    #>
}

# Export only the functions using PowerShell standard verb-noun naming.
Export-ModuleMember -Function *-*

